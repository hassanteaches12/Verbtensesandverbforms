<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Winter Grammar Quest ‚Äî Verb Tenses & Verb Forms</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com"/>
<style>
  :root{
    --bg1:#eaf6ff;
    --bg2:#f3fbff;
    --ice:#d9f0ff;
    --ink:#07314a;
    --muted:#54707f;
    --accent:#5fb3ff;
    --btn-grad: linear-gradient(90deg,#9fd6ff,#7fc7ff);
    --card-shadow: 0 18px 40px rgba(6,30,44,0.06);
    --glass: rgba(255,255,255,0.85);
    --font-sans: system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(circle at 10% 10%, #f6fcff, transparent 10%), linear-gradient(180deg,var(--bg1),var(--bg2));font-family:var(--font-sans);color:var(--ink);-webkit-font-smoothing:antialiased}
  .scene{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;position:relative;overflow:hidden}
  .snow {position:fixed;left:0;top:0;pointer-events:none;width:100%;height:100%;z-index:0}
  .wrap{width:96%;max-width:980px;margin:0 auto;position:relative;z-index:2}
  .header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .logo{width:84px;height:84px;border-radius:14px;background:linear-gradient(180deg,#fff,#e8f7ff);display:flex;align-items:center;justify-content:center;border:2px solid rgba(0,0,0,0.04);box-shadow:var(--card-shadow)}
  .header h1{margin:0;font-size:22px}
  .header p{margin:0;color:var(--muted);font-size:13px}
  .card{background:var(--glass);backdrop-filter: blur(6px);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.6);box-shadow:var(--card-shadow)}
  .form-row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
  label{display:block;font-weight:700;font-size:13px;margin-bottom:6px;color:var(--ink)}
  input[type="text"], select{padding:10px 12px;border-radius:10px;border:1px solid rgba(7,49,74,0.07);background:#fff;font-size:15px;min-width:140px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{background:var(--btn-grad);border-radius:10px;padding:10px 16px;border:1px solid rgba(7,49,74,0.06);font-weight:800;color:#05324a;cursor:pointer;box-shadow:0 8px 20px rgba(47,119,179,0.06)}
  .btn.secondary{background:#fff;border:1px solid rgba(7,49,74,0.04)}
  .btn:active{transform:translateY(1px)}
  /* quiz */
  #quiz-container{display:none;margin-top:16px}
  #quiz{margin-top:12px}
  .q-card{margin-bottom:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f2fbff);border:1px solid rgba(7,49,74,0.04);box-shadow:0 8px 26px rgba(6,30,44,0.04)}
  .q-top{display:flex;gap:12px;align-items:center}
  .q-num{background:linear-gradient(180deg,#fff,#e8f7ff);padding:8px 10px;border-radius:8px;font-weight:900;color:var(--accent);min-width:46px;text-align:center;box-shadow:0 6px 18px rgba(95,179,255,0.08)}
  .q-text{font-weight:800;color:var(--ink)}
  .opts{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .opt{padding:10px 14px;border-radius:999px;background:linear-gradient(180deg,#fbfeff,#f3fbff);cursor:pointer;border:1px solid rgba(7,49,74,0.04);font-weight:800;min-width:120px;text-align:center;transition:transform .12s, box-shadow .12s}
  .opt:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(7,49,74,0.06)}
  .opt.selected{background:linear-gradient(90deg,#dff4ff,#bfeeff);border-color:rgba(95,179,255,0.25);box-shadow:0 10px 26px rgba(95,179,255,0.06)}
  .opt.correct{background:linear-gradient(90deg,#e6fff2,#f0fff8);border-color:rgba(46,167,102,0.12);color:#0b7b4c}
  .opt.wrong{background:linear-gradient(90deg,#fff1f1,#fff6f6);border-color:rgba(224,87,78,0.12);color:#a33}
  .tf .opt{min-width:150px;padding:12px 18px}
  .quiz-actions{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:12px}
  .progress{flex:1;margin-right:10px;background:#e7f6ff;border-radius:999px;height:12px;overflow:hidden}
  .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#bfeeff,#7fc7ff);transition:width .6s}
  #results-container{display:none;margin-top:18px}
  .results-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .score{font-size:20px;font-weight:900;color:#0b5b82;margin-top:10px}
  .badge{display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(180deg,#fff,#f4fbff);box-shadow:0 12px 34px rgba(94,151,185,0.06);text-align:center}
  .badge .emoji{font-size:36px}
  .badge .title{font-weight:900;margin-top:6px}
  .small{font-size:12px;color:var(--muted)}
  @media (max-width:720px){
    .opt{min-width:unset;flex:1 1 calc(50% - 12px)}
  }
  .footer-note{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="scene">
    <canvas class="snow" id="snow-canvas"></canvas>
    <div class="wrap">
      <div class="header">
        <div class="logo card" aria-hidden="true">
          <svg width="58" height="58" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
            <rect x="6" y="10" width="52" height="42" rx="8" fill="#f7feff" stroke="#d3f0ff" stroke-width="1.6"/>
            <path d="M16 22c6-3 24-6 32 0" stroke="#99d6ff" stroke-width="2" stroke-linecap="round" fill="none"/>
            <circle cx="48" cy="22" r="4" fill="#c8f0ff"/>
          </svg>
        </div>
        <div>
          <h1>‚ùÑÔ∏è Winter Grammar Quest ‚Äî Verb Tenses & Verb Forms</h1>
          <p class="small">Select the correct option for each question. Download your result card when finished.</p>
        </div>
      </div>

      <!-- student info -->
      <section id="student-info-container" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 style="margin:0">‚òÉÔ∏è Student Details</h2>
            <div class="hint">Fill the details below, then start the quiz.</div>
            <ol style="margin:8px 0 0 18px">
              <li>Choose one option per question.</li>
              <li>Change answers anytime before submitting.</li>
              <li>Click <strong>Submit Answers</strong> to view score and review.</li>
              <li>Download a PDF result card afterwards.</li>
            </ol>
          </div>
          <div style="text-align:right;color:var(--muted)"><strong>10</strong> questions ‚Ä¢ Elementary</div>
        </div>

        <form id="student-info-form" style="margin-top:14px">
          <div class="form-row">
            <div>
              <label for="name">üß≠ Full Name</label>
              <input id="name" type="text" required placeholder="e.g. Ali Khan">
            </div>
            <div>
              <label for="roll">üé´ Roll Number</label>
              <input id="roll" type="text" required placeholder="e.g. 12">
            </div>
            <div>
              <label for="class">üè∑ Class</label>
              <select id="class" required>
                <option value="">Select</option>
                <option value="Grade 4">Grade 4</option>
                <option value="Grade 5">Grade 5</option>
                <option value="Grade 6">Grade 6</option>
              </select>
            </div>
            <div>
              <label for="section">üè∑ Section</label>
              <input id="section" type="text" required placeholder="e.g. A">
            </div>
          </div>

          <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px">
            <button type="button" class="btn secondary" onclick="previewTheme()">Preview Theme</button>
            <button type="submit" class="btn" id="begin-btn">Start Quiz ‚Äî Open the Snow Scroll ‚ùÑÔ∏è</button>
          </div>
        </form>
      </section>

      <!-- quiz -->
      <section id="quiz-container">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <h2 style="margin:0">üìò Quiz: Verb Tenses & Verb Forms</h2>
              <div class="hint">Select one option per question.</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="text-align:right">
                <div id="live-q" style="font-weight:900">Question 1 / 10</div>
                <div class="hint">Progress</div>
              </div>
              <div style="width:180px">
                <div class="progress"><i id="progress-bar"></i></div>
              </div>
            </div>
          </div>

          <div id="quiz"></div>

          <div class="quiz-actions">
            <div style="display:flex;gap:8px">
              <button class="btn secondary" id="prev-btn" onclick="prevQuestion()" disabled>‚Üê Previous</button>
              <button class="btn secondary" id="next-btn" onclick="nextQuestion()">Next ‚Üí</button>
            </div>

            <div style="display:flex;gap:10px;align-items:center">
              <div class="hint">When ready</div>
              <button id="submit-btn" class="btn" onclick="submitQuiz()">Submit Answers ‚ùÑÔ∏è</button>
            </div>
          </div>
        </div>
      </section>

      <!-- results -->
      <section id="results-container">
        <div class="card">
          <div class="results-head">
            <div>
              <h2 style="margin:0">üéâ Quiz Complete!</h2>
              <div class="hint">Here is your result card.</div>
            </div>
            <div style="text-align:right">
              <div id="name-display" style="font-weight:900"></div>
              <div id="meta-display" class="hint"></div>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:18px;justify-content:space-between;flex-wrap:wrap;margin-top:12px">
            <div style="flex:1;min-width:220px">
              <div id="score-text" class="score">Score: 0 / 10</div>
              <div class="hint">Your Rank</div>
              <div style="height:12px;background:#e7f6ff;border-radius:999px;overflow:hidden;margin-top:8px">
                <div id="rank-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#bfeeff,#7fc7ff);transition:width .8s"></div>
              </div>
              <small class="small">Ranks: Excellent (9‚Äì10), Very Good (7‚Äì8), Good (4‚Äì6), Needs Practice (0‚Äì3)</small>
            </div>

            <div style="min-width:180px;text-align:center">
              <div class="badge" id="badge">
                <div class="emoji">‚ùÑÔ∏è</div>
                <div class="title">Snow Learner</div>
                <div class="hint" id="badge-sub">Keep practising!</div>
              </div>
            </div>
          </div>

          <div style="margin-top:16px;text-align:center">
            <div style="margin-top:10px;display:flex;gap:10px;justify-content:center">
              <button class="btn" onclick="restartQuiz()">Try Again ‚Ü∫</button>
              <button class="btn secondary" onclick="downloadResults()">Download Result (PDF)</button>
            </div>
          </div>

          <div id="answers-review" style="margin-top:16px;text-align:left"></div>
          <div class="footer-note">Save or screenshot your PDF and share with your teacher.</div>
        </div>
      </section>
    </div>
  </div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------- QUESTIONS (Your quiz, renumbered 1..10) ---------- */
const quizData = [
  { type:"mcq", question: "1. Complete the sentence in the Past Continuous Tense: Rehan was _____ (talk) on the phone.", options: ["A. talk","B. talked","C. talking","D. talks"], correct: 2, explain: "Past continuous uses 'was/were + -ing' ‚Äî 'was talking'." },
  { type:"mcq", question: "2. Use the correct form of the verb drive (Simple Past Tense): The driver _____ the car fast.", options: ["A. driving","B. driven","C. drove","D. drives"], correct: 2, explain: "Simple past of 'drive' is 'drove'." },
  { type:"mcq", question: "3. Which sentence uses the verb run in the Past Continuous Tense?", options: ["A. The children run in the park.","B. The children ran in the park.","C. The children were running in the park.","D. The children have run in the park."], correct: 2, explain: "Past continuous is 'were running' for plural subject." },
  { type:"mcq", question: "4. Complete the sentence using the Simple Past form of sleep: Yesterday, I _____ (sleep) in the class.", options: ["A. sleep","B. slept","C. sleeping","D. have slept"], correct: 1, explain: "Simple past of 'sleep' is 'slept'." },
  { type:"mcq", question: "5. What is the Simple Past form of the verb break?", options: ["A. Broken","B. Broke","C. Breaking","D. Breaked"], correct: 1, explain: "Simple past of 'break' is 'broke'." },
  { type:"mcq", question: "6. What is the Past Participle form of the verb eat?", options: ["A. Ate","B. Eating","C. Eaten","D. Eat"], correct: 2, explain: "Past participle of 'eat' is 'eaten'." },
  { type:"mcq", question: "7. A verb form that ends in -ing (e.g., planting, coming) is called a:", options: ["A. Past Tense","B. Present Participle","C. Infinitive","D. Past Participle"], correct: 1, explain: "-ing form used for continuous forms is the present participle." },
  { type:"mcq", question: "8. Which sentence correctly uses a Past Participle?", options: ["A. I saw some men planting trees.","B. The bus coming up the road was late.","C. Loved by their mother, the children were happy.","D. The police caught the running thief."], correct: 2, explain: "'Loved by their mother' uses the past participle 'loved' in a passive/participial phrase." },
  { type:"mcq", question: "9. Complete the sentence in the correct Simple Past Tense: I _____ (finish) the painting all by myself.", options: ["A. finished","B. finish","C. finishing","D. had finished"], correct: 0, explain: "Simple past: 'I finished'." },
  { type:"mcq", question: "10. What is the Past Participle form of the verb send?", options: ["A. Sended","B. Sent","C. Sending","D. Sand"], correct: 1, explain: "Past participle of 'send' is 'sent'." }
];

/* ---------- STATE ---------- */
let student = {};
let answers = new Array(quizData.length).fill(null);
let currentIndex = 0;

/* ---------- UI refs ---------- */
const studentForm = document.getElementById('student-info-form');
const quizContainer = document.getElementById('quiz-container');
const quizDiv = document.getElementById('quiz');
const resultsContainer = document.getElementById('results-container');
const liveQ = document.getElementById('live-q');
const progressBar = document.getElementById('progress-bar');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');

studentForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  student.name = document.getElementById('name').value.trim();
  student.roll = document.getElementById('roll').value.trim();
  student.class = document.getElementById('class').value;
  student.section = document.getElementById('section').value.trim();
  if(!student.name || !student.roll || !student.class || !student.section){
    alert('Please fill all fields.');
    return;
  }
  startQuiz();
});

/* preview theme */
function previewTheme(){ alert('Winter theme: snowy background, soft blue buttons, and a gentle snowfall.'); }

/* ---------- RENDER ---------- */
function startQuiz(){
  document.getElementById('student-info-container').style.display='none';
  quizContainer.style.display='block';
  renderAllQuestions();
  showQuestion(0);
  updateProgress();
  playSound('start');
}

/* render function */
function renderAllQuestions(){
  quizDiv.innerHTML='';
  quizData.forEach((q,i)=>{
    const card = document.createElement('div'); card.className='q-card'; card.dataset.index=i;
    const top = document.createElement('div'); top.className='q-top';
    const num = document.createElement('div'); num.className='q-num'; num.textContent = i+1;
    const qtext = document.createElement('div'); qtext.className='q-text'; qtext.innerHTML = q.question;
    top.appendChild(num); top.appendChild(qtext); card.appendChild(top);

    const opts = document.createElement('div'); opts.className='opts';
    if(q.type === 'mcq'){
      q.options.forEach((opt,idx)=>{
        const b = document.createElement('div'); b.className='opt'; 
        // option label already includes "A. ..." so show as-is but clickable
        b.innerHTML = `<strong>${opt.slice(0,2)}</strong> ${escapeHtml(opt.slice(3))}`;
        b.dataset.opt=idx;
        b.addEventListener('click', ()=> { selectOption(i, idx, b); playSound('click'); });
        opts.appendChild(b);
      });
    } 
    card.appendChild(opts);
    quizDiv.appendChild(card);
  });
}

/* selection logic */
function selectOption(qIndex, optIndex, elem){
  answers[qIndex] = optIndex;
  const qCard = document.querySelector(`.q-card[data-index="${qIndex}"]`);
  qCard.querySelectorAll('.opt').forEach(o=> o.classList.remove('selected'));
  elem.classList.add('selected');
  markSelected(qIndex);
}
function markSelected(i){
  const qCard = document.querySelector(`.q-card[data-index="${i}"]`);
  if(!qCard) return;
  qCard.style.borderColor = answers[i] !== null ? 'rgba(127,199,255,0.22)' : 'rgba(0,0,0,0.04)';
}

/* nav */
function showQuestion(i){
  currentIndex = i;
  const all = document.querySelectorAll('.q-card');
  all.forEach((c,idx)=> c.style.display = (idx === i) ? 'block' : 'none');
  liveQ.textContent = `Question ${i+1} / ${quizData.length}`;
  prevBtn.disabled = (i === 0);
  nextBtn.disabled = (i === quizData.length - 1);
  updateProgress();
}
function prevQuestion(){ if(currentIndex>0) showQuestion(currentIndex-1); }
function nextQuestion(){ if(currentIndex<quizData.length-1) showQuestion(currentIndex+1); }
function updateProgress(){
  const answered = answers.reduce((s,a)=> s + (a !== null ? 1:0), 0);
  const percent = Math.round((answered / quizData.length)*100);
  document.getElementById('progress-bar').style.width = percent + '%';
}

/* ---------- SOUND (light) ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
function playSound(kind){
  try{
    ensureAudio();
    const now = audioCtx.currentTime;
    if(kind === 'click'){
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination); o.start();
      g.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
      o.stop(now + 0.14);
    } else if(kind === 'start'){
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type='triangle'; o.frequency.value=320; o.connect(g); g.connect(audioCtx.destination);
      g.gain.value=0.0001; o.start();
      g.gain.exponentialRampToValueAtTime(0.06, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.30);
      o.stop(now+0.32);
    } else if(kind === 'fanfare'){
      const freqs=[440,560,720];
      freqs.forEach((f,idx)=>{
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination); g.gain.value=0.0001;
        o.start(now + idx*0.12); g.gain.exponentialRampToValueAtTime(0.09, now+idx*0.12+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now+idx*0.12+0.32); o.stop(now+idx*0.12+0.34);
      });
    }
  }catch(e){}
}

/* ---------- SUBMIT & SCORING ---------- */
function submitQuiz(){
  const answeredCount = answers.reduce((s,a)=> s + (a !== null ? 1:0), 0);
  if(answeredCount === 0 && !confirm('You have not answered any question. Submit anyway?')) return;

  let score = 0;
  let reviewHtml = '<h3 style="margin-top:0">Answers Review</h3><ol>';
  quizData.forEach((q,i)=>{
    const user = answers[i];
    let correct = false;
    if(q.type === 'mcq'){
      if(user !== null && parseInt(user) === q.correct){ correct = true; score++; }
    }
    const userText = user === null ? '<em>Not answered</em>' : `${String.fromCharCode(65+user)}) ${q.options[user].slice(3)}`;
    const correctText = `${String.fromCharCode(65+q.correct)}) ${q.options[q.correct].slice(3)}`;
    reviewHtml += `<li style="margin-bottom:10px"><strong>${escapeHtml(q.question)}</strong><div class="small">Your answer: ${userText} ‚Äî ${correct ? '<span style="color:green">Correct</span>' : '<span style="color:red">Wrong</span>'}</div><div style="margin-top:6px;color:#244f5f"><em>Answer:</em> ${correctText} ‚Äî <small style="color:#244f5f">${escapeHtml(q.explain)}</small></div></li>`;
  });
  reviewHtml += '</ol>';

  quizContainer.style.display='none';
  resultsContainer.style.display='block';
  document.getElementById('name-display').textContent = student.name;
  document.getElementById('meta-display').textContent = `Roll ${student.roll} ‚Äî ${student.class} ‚Äî Section ${student.section}`;
  const total = quizData.length;
  document.getElementById('score-text').textContent = `Score: ${score} / ${total}`;
  document.getElementById('answers-review').innerHTML = reviewHtml;

  const pct = Math.round((score/total)*100);
  document.getElementById('rank-bar').style.width = pct + '%';
  const badge = document.getElementById('badge');
  const badgeSub = document.getElementById('badge-sub');

  if(score >= 9){
    badge.querySelector('.emoji').textContent = 'üèÜ';
    badge.querySelector('.title').textContent = 'Excellent';
    badgeSub.textContent = 'Outstanding performance!';
    playSound('fanfare');
  } else if(score >= 7){
    badge.querySelector('.emoji').textContent = 'üéñÔ∏è';
    badge.querySelector('.title').textContent = 'Very Good';
    badgeSub.textContent = 'Great job ‚Äî keep it up!';
    playSound('fanfare');
  } else if(score >= 4){
    badge.querySelector('.emoji').textContent = '‚õÑ';
    badge.querySelector('.title').textContent = 'Good';
    badgeSub.textContent = 'Nice effort ‚Äî practice more.';
  } else {
    badge.querySelector('.emoji').textContent = '‚ùÑÔ∏è';
    badge.querySelector('.title').textContent = 'Needs Practice';
    badgeSub.textContent = 'Try again ‚Äî you can improve!';
  }
}

/* ---------- RESTART / DOWNLOAD (PDF) ---------- */
function restartQuiz(){
  answers = new Array(quizData.length).fill(null);
  currentIndex = 0;
  document.getElementById('quiz').innerHTML = '';
  document.getElementById('student-info-container').style.display = 'block';
  document.getElementById('results-container').style.display = 'none';
  quizContainer.style.display = 'none';
  document.getElementById('student-info-form').reset();
}

/* PDF result generation using jsPDF */
async function downloadResults(){
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4'});
    const margin = 40;
    let y = margin;

    doc.setFontSize(16);
    doc.setTextColor(8,40,60);
    doc.text('Winter Grammar Quest ‚Äî Result Card', margin, y);
    y += 22;

    doc.setFontSize(11);
    doc.text(`Name: ${student.name}`, margin, y); doc.text(`Roll: ${student.roll}`, 320, y);
    y += 16;
    doc.text(`Class: ${student.class}`, margin, y); doc.text(`Section: ${student.section}`, 320, y);
    y += 20;

    const scoreText = document.getElementById('score-text').textContent;
    doc.setFontSize(13);
    doc.text(scoreText, margin, y);
    y += 18;

    doc.setDrawColor(140,190,220);
    doc.setLineWidth(1);
    doc.line(margin, y, 560, y);
    y += 14;

    doc.setFontSize(10);
    const pageHeight = doc.internal.pageSize.height;

    for(let i=0;i<quizData.length;i++){
      const q = quizData[i];
      const user = answers[i];
      let userText = '';
      let correctText = '';
      let correct = false;

      userText = (user === null) ? 'Not answered' : `${String.fromCharCode(65+user)}) ${q.options[user].slice(3)}`;
      correctText = `${String.fromCharCode(65+q.correct)}) ${q.options[q.correct].slice(3)}`;
      correct = (user !== null && parseInt(user) === q.correct);

      const qTitle = `${i+1}. ${q.question}`;
      const splitQ = doc.splitTextToSize(qTitle, 520 - margin);
      if(y + (splitQ.length * 12) > pageHeight - 60){ doc.addPage(); y = margin; }
      doc.setFont(undefined, 'bold');
      doc.text(splitQ, margin, y);
      y += splitQ.length * 12;
      doc.setFont(undefined, 'normal');

      const ansLine = `Your answer: ${userText}   |   Correct: ${correctText}`;
      const splitAns = doc.splitTextToSize(ansLine, 520 - margin);
      if(y + (splitAns.length * 11) > pageHeight - 60){ doc.addPage(); y = margin; }
      doc.text(splitAns, margin+6, y);
      y += splitAns.length * 11;

      const expl = `Explanation: ${q.explain}`;
      const splitExpl = doc.splitTextToSize(expl, 520 - margin);
      if(y + (splitExpl.length * 11) > pageHeight - 60){ doc.addPage(); y = margin; }
      if(correct) doc.setTextColor(12,100,52); else doc.setTextColor(150,40,40);
      doc.text(splitExpl, margin+6, y);
      y += splitExpl.length * 11 + 8;
      doc.setTextColor(8,40,60);

      doc.setDrawColor(220,235,245);
      doc.setLineWidth(0.6);
      doc.line(margin, y, 560, y);
      y += 10;
    }

    const fileName = `${student.name.replace(/\s+/g,'_')}_VerbTenses_Result.pdf`;
    doc.save(fileName);
  } catch (err){
    alert('Could not generate PDF. Please make sure you are online and try again.');
    console.error(err);
  }
}

/* util */
function escapeHtml(t){ return String(t).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ---------- SNOW ANIMATION (canvas) ---------- */
(function initSnow(){
  const canvas = document.getElementById('snow-canvas');
  const ctx = canvas.getContext('2d');
  let width = canvas.width = window.innerWidth;
  let height = canvas.height = window.innerHeight;
  const flakes = [];
  const flakeCount = Math.floor((width*height)/60000) * 60 + 40;

  for(let i=0;i<flakeCount;i++){
    flakes.push({
      x: Math.random()*width,
      y: Math.random()*height,
      r: Math.random()*3+1,
      d: Math.random()*1.5
    });
  }

  function resize(){ width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
  window.addEventListener('resize', resize);

  let angle = 0;
  function draw(){
    ctx.clearRect(0,0,width,height);
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.beginPath();
    for(let i=0;i<flakes.length;i++){
      const f = flakes[i];
      ctx.moveTo(f.x, f.y);
      ctx.arc(f.x, f.y, f.r, 0, Math.PI*2, true);
    }
    ctx.fill();
    update();
    requestAnimationFrame(draw);
  }
  function update(){
    angle += 0.002;
    for(let i=0;i<flakes.length;i++){
      const f = flakes[i];
      f.y += Math.cos(angle + f.d) + 0.6 + f.r/3;
      f.x += Math.sin(angle) * 1;
      if(f.x > width + 5 || f.x < -5 || f.y > height + 5){
        if(i%3>0){ flakes[i] = {x: Math.random()*width, y: -10, r: f.r, d: f.d}; }
        else { flakes[i] = {x: Math.random()*width, y: Math.random()*height, r: f.r, d: f.d}; }
      }
    }
  }
  draw();
})();

/* ---------- Expose navigation globally ---------- */
window.startQuiz = startQuiz;
window.prevQuestion = prevQuestion;
window.nextQuestion = nextQuestion;
window.restartQuiz = restartQuiz;
window.downloadResults = downloadResults;
</script>
</body>
</html>